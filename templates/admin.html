<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f5f7ff, #dfe9ff);
      padding: 2rem;
    }
    h2 {
      color: #3F51B5;
      font-weight: bold;
    }
    .badge {
      font-size: 0.8rem;
      padding: 0.5em 0.7em;
    }
    .card {
      border-radius: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .escalated {
      border: 2px solid #ff5722;
    }
  </style>
</head>
<body>
  <h2>üö® Admin Dashboard - Manage Reports</h2>

  <div class="row mb-3">
    <div class="col-md-6">
      <label>Status:</label>
      <select id="filterStatus" class="form-select">
        <option value="all">All</option>
        <option value="Reported">Reported</option>
        <option value="In Progress">In Progress</option>
        <option value="Resolved">Resolved</option>
      </select>
    </div>
    <div class="col-md-6">
      <label>Category:</label>
      <select id="filterCategory" class="form-select">
        <option value="all">All</option>
        <option value="roads">Roads</option>
        <option value="lighting">Lighting</option>
        <option value="water">Water</option>
        <option value="cleanliness">Cleanliness</option>
        <option value="safety">Safety</option>
      </select>
    </div>
  </div>

  <div id="issues-container"></div>

  <script>
    const issues = {{ issues | tojson | safe }};
    const container = document.getElementById('issues-container');

    function renderIssues() {
      const status = document.getElementById('filterStatus').value;
      const category = document.getElementById('filterCategory').value;

      container.innerHTML = '';

      issues.forEach(issue => {
        const statusMatch = (status === 'all' || issue.status === status);
        const catMatch = (category === 'all' || issue.category === category);
        if (!(statusMatch && catMatch)) return;

        const card = document.createElement('div');
        card.className = `card ${issue.escalated ? 'escalated' : ''}`;
        card.innerHTML = `
          <h5>${issue.title} <span class="badge bg-${getBadge(issue.status)}">${issue.status}</span></h5>
          <p><strong>${issue.category}</strong></p>
          <p>${issue.description}</p>
          <p><strong>Lat:</strong> ${issue.lat} | <strong>Lng:</strong> ${issue.lng}</p>
          ${issue.images ? `<img src="/static/uploads/${issue.images.split(',')[0]}" width="100"/>` : ''}
          <br><br>
          <button class="btn btn-sm btn-outline-danger me-2" onclick="deleteIssue(${issue.id})">üóëÔ∏è Delete</button>
          <button class="btn btn-sm btn-outline-warning" onclick="toggleEscalation(${issue.id}, ${issue.escalated})">
            ${issue.escalated ? '‚¨áÔ∏è Remove Escalation' : '‚¨ÜÔ∏è Escalate'}
          </button>
        `;
        container.appendChild(card);
      });
    }

    function getBadge(status) {
      if (status === 'Reported') return 'danger';
      if (status === 'In Progress') return 'warning';
      return 'success';
    }

    function deleteIssue(id) {
      if (!confirm("Delete this issue?")) return;
      fetch(`/delete_issue/${id}`, { method: 'POST' })
        .then(() => location.reload());
    }

    function toggleEscalation(id, current) {
      fetch(`/toggle_escalation/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ current: current })
      })
      .then(() => location.reload());
    }

    document.getElementById('filterStatus').addEventListener('change', renderIssues);
    document.getElementById('filterCategory').addEventListener('change', renderIssues);
    renderIssues();
  </script>
</body>
</html>
